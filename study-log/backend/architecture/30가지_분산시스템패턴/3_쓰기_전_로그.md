# 쓰기 전 로그(WAL)
- 컨셉: 상태를 바꾸기 전에, 그 변경 명령을 안전한 로그에 먼저 기록하자
- 목적: 서버가 죽어도 로그 리플레이로 상태를 복구하고, 트랜잭션의 원자적·지속적인 갱신을 구현한다
- 커밋 로그(commit log) 라고도 부른다

  
# 동작 방식
- 각 서버 프로세스는 자기만의 단일 로그 파일을 가지며, 여기에 순차적으로 append 한다.
- 각 로그 엔트리에는 고유 식별자(ID) 를 부여해 분할 로그(Segmented Log), 로우 워터마크(Low-Water Mark) 등의 관리 작업에 활용한다.
- 재시작 시, 로그 파일을 처음부터 읽고 모든 로그 엔트리를 순서대로 다시 실행해 메모리상의 상태를 복구한다.

# 구현 시 고려사항
### 3-1. 디스크 flush와 성능 트레이드오프
- 로그를 쓴 뒤 실제 물리 디스크에 기록되었는지(flush) 확인해야함
  - 매번 쓰기 후 바로 flush:
    - 장점: 가장 강한 지속성 보장
    - 단점: 성능 저하, 병목(bottleneck) 발생
  - flush를 지연 또는 비동기로 처리:
    - 장점: 성능 향상, 처리량 증가
    - 단점: flush 전에 서버가 죽으면 로그 엔트리 유실 위험
- 대부분의 구현은 묶음 처리(batching) 로 flush 오버헤드를 줄인다.
### 3-2. 로그 손상 감지
- 파일을 읽을 때 엔트리가 손상되었는지 확인해야 한다.
  - 보통 로그 엔트리마다 CRC(checksum) 를 기록해 읽을 때 검증한다.
  - 또는 엔트리 종료 마커(end-of-entry marker) 로 “여기까지가 정상적으로 기록된 엔트리”임을 표시하고, 마커가 없는 마지막 조각은 복구 시 버린다.
### 3-3. 로그 크기 관리
- 단일 로그 파일은 점점 커져 관리 어려움 + 용량 문제 발생
 - 분할 로그(Segmented Log), 로우 워터마크(Low-Water Mark) 등을 사용해 불필요한 과거 엔트리를 정리/삭제한다.
### 3-4. 중복 엔트리 처리
- 로그는 append-only라 클라이언트 재시도 때문에 동일 작업이 중복해서 로그에 기록될 수 있음.
 - 상태를 적용할 때 만약 연산이 멱등(idempotent) (예: 같은 키에 같은 값 쓰기)하면 특별한 처리 없이도 문제 없음.
 - 그렇지 않다면 요청마다 고유 ID 를 두어, 이미 처리된 요청인지 체크해야 한다.


# 저장 매체와 복제
- 쓰기 전 로그는 기본적으로 저장 매체(디스크)는 안전하다는 가정을 전제로 한다.
  - 디스크 자체가 망가지면 로그도 함께 사라질 수 있음.
  - 이런 장애까지 견디려면 복제 로그(Replicated Log) 패턴을 추가로 사용해야 한다.

# 현대 스토리지에서의 위치
- 오늘날 시스템은 대개 RAM에서 상태를 관리하고, 필요 시 디스크에 기록하기 때문에 WAL 패턴이 널리 사용된다.
- 향후 비휘발성 메모리(NVM, 예: Intel Optane) 가 일반화되면, 지금과 같은 형태의 쓰기 전 로그 필요성이 줄어들 가능성이 있고, 쓰기 후 로그(write-behind) 같은 다른 기법이 부각될 수 있다.

# 트랜잭션 저장소에서의 활용
- 트랜잭션의 핵심 속성 중 원자성(atomicity)과 지속성(durability) 을 구현하는 데 적합.
  - 트랜잭션 내 여러 변경을 하나의 원자적 단위로 기록.
  - 커밋되면 로그에 기록된 내용이 보존되고, 실패하면 적용되지 않는다.
- 일관성(consistency), 격리성(isolation)은 보통 잠금(lock) + 동시성 제어로 따로 구현.
```
예: RocksDB
여러 키-값 변경을 배치(batch) 로 묶어 한 번에 처리.
이 배치 전체를 하나의 로그 엔트리로 WAL에 기록.
로그에 성공적으로 기록된 후 실제 키-값 저장소에 반영.
```

# 이벤트 소싱(Event Sourcing)과의 비교
### 공통점
- 둘 다 “변경 사항을 로그로 기록하고, 로그를 재실행하여 상태를 복구”하는 개념을 사용.
### 차이점
- 쓰기 전 로그(WAL) 목적: 장애 복구와 지속성.
  - 로그는 상태 복구 용도로만 필요하고,
  - 시스템이 안정되면 로우 워터마크 이하 엔트리는 삭제 가능.
  - “진실의 원천(source of truth)”는 보통 현재 상태(스토어).
- 이벤트 소싱(Event Sourcing) 목적: 도메인 이벤트를 영구히 기록하고, 과거 모든 상태/이력 재구성.
  - 이벤트 로그 자체가 진실의 원천.
  - 로그를 매우 오래, 심지어 무기한 보관하는 경우가 많다.
  - 과거 시점 상태 재구성, 감사 로그(audit), 다른 시스템과 동기화 등에 적극 활용.
