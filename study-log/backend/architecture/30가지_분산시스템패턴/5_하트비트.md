# 목적
- 서버 실패를 감지하여 대체 동작하기 위해
- 주기적으로 다른 서버들에게 생존해있음을 알림

# 설계
- 하트비트 간격이 짧을수록 실패를 더 빨리 감지하나 네트워크 지연만으로도 가짜 실패가 늘어날 수 있음
- 몇 번 연속 누락되었을 때 실패로 볼지(타임아웃), 네트워크 특성(RTT, 지터) 등을 고려해 클러스터 특성에 맞게 조정해야 한다.

# 3~5대 노드의 소규모 클러스터(합의 기반)
- 동작
  - 리더는 주기적으로 모든 팔로워에게 하트비트를 전송하고, 팔로워는 하트비트를 받을 때마다 수신 시점의 타임스탬프를 기록한다.
  - 일정 시간(타임아웃) 동안 하트비트를 받지 못하면 리더가 죽었다고 판단하고, 새로운 리더를 선출한다.
- 이슈
  - 하트비트가 늦게 도착해서 실패로 오인
    - 세대 시계(Generation Clock)를 사용해 “이 리더가 예전 리더인지”를 구분한다.
  - HOL(Head-of-Line) 블로킹 문제(서버 간 통신을 단일 소켓 채널로 할 때, 앞쪽 요청이 지연되면 뒤에 있는 하트비트도 같이 지연)
    - 이전 요청 응답을 기다리지 않고 하트비트를 먼저 보낼 수 있도록 구성
    - 별도의 스레드에서 비동기로 하트비트 전송
    - 수신 서버가 디스크 쓰기 중이면 하트비트 확인이 늦어져 가짜 실패로 이어질 수 있음. 수신 서버도 하트비트 확인 로직의 타이밍을 조정/재설정 .
  - GC(가비지 컬렉션) 같은 런타임 이벤트 때문에 프로세스가 잠깐 멈추는 경우
    - 잠시 보류하고 다음 주기에 다시 확인하는 방식으로 처리
   

# 대규모 클러스터
- all-to-all 메시징 불가능, 각 서버가 보내는 메시지 수와 크기 제한 필요
- 가십 전파(Gossip Dissemination) 프로토콜 + 의심 번호(suspicion number) 기반 실패 감지
  - 각 노드는 주기적으로 임의의 다른 노드 몇 개를 고른다.
  - 자신이 알고 있는 상태 정보를 그 노드에게 보내거나 받아온다.
  - 각 프로세스마다 의심 번호를 두고 일정 시간 동안 그 프로세스에 대한 가십 정보가 안 오면 의심번호 증가, 설정값 도달 시 실패로 처리
