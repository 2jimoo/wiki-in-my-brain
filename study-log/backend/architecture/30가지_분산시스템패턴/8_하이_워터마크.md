# 정의
- 가장 최근에 성공한 복제를 나타내는 쓰기 전 로그의 인덱스로，커밋 인덱스(commitindex)라고도 한다

# 문제
- WAL은 재시작 후 복구엔 좋지만, 서버가 죽어 있는 동안엔 가용성을 못 보장한다.
  - WAL은 로그 파일일 뿐이라, 서버 프로세스가 꺼져 있으면 그 로그가 있어도 클라이언트 요청을 대신 처리해줄 수가 없음
- 각 노드는 **어디까지가 커밋(안전)된 구간인지** 알아야 그 범위까지만 클라이언트에 제공할 수 있다.


# 하이워터마크
- 과반수 정족수에 성공적으로 복제된 마지막 로그 인덱스
  - 리더는 로그를 팔로워에 복제하면서 각 팔로워의 복제 상태를 수집해, 서버 과반수 이상이 가진 인덱스를 하이 워터마크로 계산한다.
- 클러스터의 모든 서버는 하이 워터마크 이하의 로그만 클라이언트에게 제공해야 하며, 그 이후 엔트리는 아직 안전하지 않다.
  - 리더는 하트비트나 별도 메시지로 하이 워터마크를 팔로워에 전파하고, 팔로워도 이를 기준으로 응답 범위를 제한한다.
  - 하이 워터마크를 넘는 로그는 리더 장애 시 폐기될 수 있으므로, 클라이언트는 해당 엔트리를 볼 수 없다.

# 로그절단
- 목적
  - 서버가 장애 후 재시작하거나 일시 중단 후 클러스터에 복귀할 때 **자신의 로그를 클러스터의 다른 서버들과 완전히 동일한 상태로 맞추기 위해**
  - 이전 리더였던 서버가 **커밋되지 않은 로그 엔트리**를 가지고 있어 **로그 불일치·데이터 오류가 발생하는 것을 방지**하기 위해
- 방법
  - 서버가 클러스터에 다시 합류하면 최신 리더를 찾아 **현재 하이 워터마크**를 요청한다
  - 자신의 로그를 **하이 워터마크까지만 남기고 절단(truncate)** 한다
  - 이후 리더로부터 **하이 워터마크 이후의 모든 로그 엔트리**를 다시 받아온다
  - **같은 로그 인덱스인데 세대 시계(Generation Clock)가 다른 경우** 로그 충돌로 판단하며 세대가 더 낮은(오래된) 엔트리를 제거한다
  - 구현 시에는 **로그 인덱스와 파일 위치 매핑**을 이용해, 특정 인덱스 이후 로그를 파일 수준에서 잘라낸다
