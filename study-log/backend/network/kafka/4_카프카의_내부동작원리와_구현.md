# 리플리케이션 
- 브로커 장애에도 메세지 손실없이 통신
- 리더와 팔로워
 - 모든 읽쓰는 리더를 통해서만 가능
 - ISR이라는 논리적그룹으로 묶여있어, 해당 그룹내 팔로워만 리더가 될 수 있고, 리더는 모든 팔로워가 메세지 가져갈 때까지 기다림
   - 특정시간 내 안 가져가면 죽은 팔로워로 판단해 내쫓음
   - 팔로워의 요청 Offset보고 어디까지 가져갔는지 판단 가능
   - pull 방식에 의해 리더 부하 적음
 - 다 복제해가면 리더 내부적으로 커밋(최종 오프셋-하이워터마크)
   - 리플리케이션 팩터만큼의 팔로워가 메세지를 저장한 위치
   - 커밋된 메세지만 팔로워가 읽어갈 수 있음
  

# 리더 에포크와 복구
- 리더 에포크
  - 파티션 복구 시 메세지 일과성 유지를 위해 사용
  - 리플리케이션 프로토콜에 의해 전파, 컨트롤러가 관리하는 값
  - 복구 동작 시 죽은 리더의 하이워터마크를 대체하는 수단으로도 활용
- Case1. 메세지 유실 
  - 팔로워 죽었다 깨면서 자기가 가진 메세지 중 하이워터마크보다 높은 건 삭제
  - 리더 죽고 새로운 리더가 뽑혔는데 팔로워가 받아야할 다음 메세지가 없는 멤버가 리더가 된 것임~ 이미 삭제 했는데~ 
  - 리더 에포크 요청해서 바로 삭제 안 하고 하이워터마크를 올림
- Case2. 오프셋은 같은데 다른 메세지
  - 팔로워 리더 죽었다 깻음 아 하이워터마크 같네 안 삭제~ 햇는데 알고보니 죽었다 깨서 메세지 새로 받아서 같아진 거임
  - 뉴리더는 자신이 팔로워일 때의 하이워터마크와 리더일 때의 하이워터마크를 따로 저장하고 있음
  - 리더 에포크 번호와 오프셋 번호로 응답


# 컨트롤러
- 리더선출을 맡고 있는 클러스터 내 어떤 브로커
- 파티션의 ISR 리스트 중 리더 선출, 주키퍼에 내용 기록 후 모든 브로커에 전파
- 장애로 인한 급종료, 다운타임이 있는 graceful 종료(로그 디스크 동기화 후 종료)

# 로그(로그 세그먼트)
- 토픽의 메세지가 저장되는 파일
  - 롤링전략
  - 세그먼트 크기가 1G면 새 파일에 저장
- 삭제와 컴팩션
  - 메세지의 key별 마지막 값만 남김
  - 장애 복구는 빠른데 최종값만 필요한 건지 고려 필요
  - 로그 컴팩션 수행으로 과도한 I/O발생가능
